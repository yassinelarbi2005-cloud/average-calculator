<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ÿ™ÿ∑ÿ®ŸäŸÇ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ¨ÿßŸÖÿπŸä ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä ÿ®ÿØŸÇÿ©ÿå ŸäÿØÿπŸÖ ŸÖÿÆÿ™ŸÑŸÅ ÿßŸÑÿ™ÿÆÿµÿµÿßÿ™ (MI, ST, ÿßŸÑÿ∑ÿ®ÿå ÿßŸÑÿ™ÿ≥ŸàŸäŸÇ) ŸÖÿπ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨.">
    <title>ÿ≠ÿßÿ≥ÿ® ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ¨ÿßŸÖÿπŸä | GPA Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- V23 THEME (Refined & Accessible) --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        :root { 
            --bg-deep: #030712; 
            --glass-surface: rgba(17, 24, 39, 0.7); 
            --glass-border: rgba(255, 255, 255, 0.08); 
            --glass-input: rgba(255, 255, 255, 0.08);
            --glass-input-border: rgba(255, 255, 255, 0.15);
            --neon-blue: #3b82f6; 
            --neon-green: #10b981; 
            --neon-red: #ef4444; 
            --text-main: #f8fafc; 
            --text-muted: #94a3b8;
        }
        
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-deep); color: var(--text-main); margin: 0; padding: 20px 16px; min-height: 100vh; overflow-x: hidden; position: relative; }
        
        /* Reduced visual noise in background */
        body::before { content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, rgba(59,130,246,0.1), transparent 60%), radial-gradient(circle at 80% 20%, rgba(139,92,246,0.1), transparent 50%); animation: nebulaMove 20s infinite alternate linear; z-index: -1; pointer-events: none; will-change: transform; opacity: 0.7; }
        @keyframes nebulaMove { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(-5%, -5%) rotate(5deg); } }

        /* A11y Helper */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        .container { max-width: 600px; margin: 0 auto; padding-bottom: 140px; }
        
        /* Header */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { font-size: 1.5rem; font-weight: 900; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        
        .btn-glass { width: 44px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; backdrop-filter: blur(10px); }
        .btn-glass:hover { background: rgba(255,255,255,0.1); }
        .editing .btn-glass { background: var(--text-main); color: #000; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

        /* GPA Ring */
        .gpa-section { display: flex; justify-content: center; margin-bottom: 40px; position: relative; }
        .ring-container { width: 200px; height: 200px; position: relative; display: flex; justify-content: center; align-items: center; }
        svg.progress-ring { transform: rotate(-90deg); width: 180px; height: 180px; overflow: visible; }
        circle { fill: transparent; stroke-width: 8; stroke-linecap: round; cx: 90; cy: 90; r: 80; }
        .ring-bg { stroke: var(--glass-border); }
        .ring-fill { stroke: var(--neon-blue); stroke-dasharray: 502; stroke-dashoffset: 502; transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s; filter: drop-shadow(0 0 15px currentColor); }
        .gpa-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 2; }
        .gpa-number { font-size: 3rem; font-weight: 900; line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .gpa-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        /* Card Styles */
        .card { background: var(--glass-surface); border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; margin-bottom: 16px; position: relative; overflow: hidden; animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        
        .subject-input { flex: 1; min-width: 0; background: transparent; border: none; color: white; font-family: 'Tajawal'; font-weight: 900; font-size: 1.15rem; padding: 4px 0; border-radius: 4px; transition: 0.3s; }
        .subject-input.editable { border-bottom: 1px solid var(--neon-blue); background: rgba(59, 130, 246, 0.1); padding: 4px 8px; }

        .controls-wrapper { display: flex; align-items: center; gap: 8px; }
        .coeff-badge { font-size: 0.75rem; color: #fbbf24; font-weight: bold; background: rgba(251, 191, 36, 0.15); padding: 4px 8px; border-radius: 6px; }
        .coeff-edit { width: 45px; background: #000; border: 1px solid var(--neon-blue); color: white; border-radius: 6px; text-align: center; font-weight: bold; padding: 4px; display: none; }
        .editing .coeff-badge { display: none; }
        .editing .coeff-edit { display: block; }
        .btn-trash { width: 32px; height: 32px; border-radius: 8px; border: none; background: rgba(239, 68, 68, 0.2); color: var(--neon-red); display: none; align-items: center; justify-content: center; cursor: pointer; }
        .editing .btn-trash { display: flex; }

        .toggles-row { display: none; gap: 8px; margin-bottom: 15px; }
        .editing .toggles-row { display: flex; }
        .toggle-chip { flex: 1; background: rgba(255,255,255,0.05); color: var(--text-muted); padding: 6px; text-align: center; border-radius: 8px; font-size: 0.75rem; font-weight: bold; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .toggle-chip.active { background: rgba(59, 130, 246, 0.2); color: var(--neon-blue); border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.1); }

        .grades-grid { display: flex; gap: 12px; }
        .input-group { flex: 1; position: relative; transition: 0.3s; }
        .input-group.hidden { opacity: 0; pointer-events: none; visibility: hidden; width: 0; padding: 0; overflow: hidden; flex: 0; margin: 0; }
        .floating-label { position: absolute; top: -8px; right: 12px; font-size: 0.65rem; font-weight: 800; color: var(--text-muted); background: var(--bg-deep); padding: 0 4px; border-radius: 4px; z-index: 2; pointer-events: none; }
        
        .grade-input { width: 100%; background: var(--glass-input); border: 1px solid var(--glass-input-border); border-radius: 12px; color: white; padding: 14px; text-align: center; font-family: 'Tajawal'; font-weight: 700; font-size: 1.1rem; transition: 0.3s; }
        .grade-input:focus { border-color: var(--neon-blue); background: rgba(255,255,255,0.12); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .grade-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .grade-input.error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--neon-red) !important; color: var(--neon-red); }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .card-footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: var(--text-muted); }
        .score-display { font-weight: 900; font-size: 1.1rem; }

        .controls-area { display: none; margin-top: 30px; animation: slideUp 0.3s; }
        .editing .controls-area { display: block; }
        .preset-box { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px; margin-bottom: 20px; }
        .preset-label { color: var(--neon-blue); font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 10px; }
        select { width: 100%; padding: 12px; border-radius: 10px; background: #0f172a; color: white; border: 1px solid var(--glass-border); font-family: 'Tajawal'; margin-bottom: 10px; }
        
        .btn-row { display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 0.8rem; }
        .btn-save { background: rgba(16, 185, 129, 0.2); color: var(--neon-green); border: 1px solid rgba(16, 185, 129, 0.3); }
        .btn-del { background: rgba(239, 68, 68, 0.2); color: var(--neon-red); border: 1px solid rgba(239, 68, 68, 0.3); }
        .fab-main { width: 100%; background: var(--text-main); color: #000; padding: 14px; border-radius: 16px; border: none; font-weight: 900; font-size: 1rem; cursor: pointer; margin-top: 10px; box-shadow: 0 5px 15px rgba(255,255,255,0.1); transition: transform 0.2s; }
        .fab-main:active { transform: scale(0.98); }
        
        .reset-link { display: block; text-align: center; margin-top: 30px; color: var(--text-muted); text-decoration: underline; font-size: 0.8rem; cursor: pointer; background: none; border: none; width: 100%; }
        
        .download-btn { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 20px auto; padding: 12px 20px; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 0.9rem; transition: 0.3s; width: fit-content; }
        .download-btn:active { transform: scale(0.95); background: rgba(59, 130, 246, 0.2); }
        
        .footer-credit { text-align: center; margin-top: 30px; color: rgba(255,255,255,0.3); font-size: 0.8rem; }
    </style>
</head>
<body>

<main class="container" id="mainContainer">
    <header class="top-nav">
        <button class="btn-glass" onclick="toggleEditMode()" id="editBtn" aria-label="ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ">
            <svg aria-hidden="true" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </button>
        <h1 class="brand">ÿ≠ÿßÿ≥ÿ® ÿßŸÑŸÖÿπÿØŸÑ</h1>
        <div style="width: 44px;" aria-hidden="true"></div>
    </header>
    
    <section class="gpa-section" aria-label="ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿπÿßŸÖ">
        <div class="ring-container">
            <svg class="progress-ring" aria-hidden="true"><defs><filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="8" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle class="ring-bg"></circle><circle class="ring-fill" id="ringCircle" filter="url(#glow)"></circle></svg>
            <div class="gpa-content">
                <div class="gpa-number" id="finalAverage" role="status" aria-live="polite">0.00</div>
                <div class="gpa-label">ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿπÿßŸÖ</div>
            </div>
        </div>
    </section>
    
    <section id="subjectsContainer" aria-label="ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿßÿØ"></section>
    
    <section class="controls-area" aria-label="ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖŸàÿßÿØ ŸàÿßŸÑŸÜŸÖÿßÿ∞ÿ¨">
        <div class="preset-box">
            <label for="presetSelect" class="preset-label">üìÇ ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ™ÿÆÿµÿµÿßÿ™ (DZ)</label>
            <select id="presetSelect" onchange="loadPreset(this.value)">
                <option value="" disabled selected>ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿÆÿµÿµ...</option>
            </select>
            <div class="btn-row">
                <button class="action-btn btn-save" onclick="saveCurrentAsPreset()">ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨</button>
                <button class="action-btn btn-del" onclick="deletePreset()">ÿ≠ÿ∞ŸÅ</button>
            </div>
        </div>
        <button class="fab-main" onclick="addNewSubject()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿßÿØÿ© ÿ¨ÿØŸäÿØÿ©</button>
    </section>
    
    <button class="reset-link" onclick="clearMarksOnly()">ŸÖÿ≥ÿ≠ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ŸÅŸÇÿ∑</button>
    
    <a href="https://www.mediafire.com/file/12s4cmal4gmgz0p/%25D8%25AD%25D8%25A7%25D8%25B3%25D8%25A8_%25D8%25A7%25D9%2584%25D9%2585%25D8%25B9%25D8%25AF%25D9%2584.apk/file" class="download-btn" id="dlLink" download>
        <svg aria-hidden="true" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    </a>

    <footer class="footer-credit">
        Designed by <a href="https://www.instagram.com/ysnlb" target="_blank" rel="noopener noreferrer" style="color:var(--neon-blue);text-decoration:none;">@ysnlb</a>
    </footer>
</main>

<script>
    // --- V48 STABLE AUDIO SYSTEM (Fixed Intermittent Sound) ---
    // Using a single context and unlocking it on first user interaction
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Unlock Audio Context (Mobile Fix)
    const unlockAudio = () => {
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        // Play silent buffer to wake up the audio engine
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);

        // Remove listeners once unlocked
        document.removeEventListener('click', unlockAudio);
        document.removeEventListener('touchstart', unlockAudio);
    };

    // Listen for any first interaction
    document.addEventListener('click', unlockAudio);
    document.addEventListener('touchstart', unlockAudio);

    function playTap() {
        // Ensure context is running before playing
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
        
        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
    }

    function playKey() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.03);
        gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.03);
    }

    function playErrorSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
    }

    // Consolidated Event Listener for UI Sounds
    document.addEventListener('click', function(e) {
    if (e.target.closest('#editBtn')) return; // ŸÖŸÜÿπ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™ ŸÖÿ±ÿ™ŸäŸÜ ŸÑŸÖÿß Ÿäÿ∂ÿ∫ÿ∑Ÿà ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ™ÿπÿØŸäŸÑ
    if (e.target.closest('button') || e.target.closest('select') || e.target.closest('.toggle-chip') || e.target.closest('.action-btn')) {
        playTap();
    }
});

    const clapUrl = 'https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c1539c.mp3?filename=applause-1-2989.mp3'; 
    const clapAudio = new Audio(clapUrl);
    function playClap() { 
        clapAudio.currentTime = 0; 
        clapAudio.play().catch(e => console.log("Sound autoplay blocked or no net")); 
    }

    let lastAvg = 0;

    const systemPresets = {
        "MI_S1": { displayName: "Math & Info (MI) - S1", subjects: [ { name: "Analyse 1", examWeight: 0.6, contWeight: 0.4, coeff: 4 }, { name: "Alg√®bre 1", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Algorithmique 1", examWeight: 0.6, contWeight: 0.4, coeff: 4 }, { name: "Structure Machine 1", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Terminologie", examWeight: 1.0, contWeight: 0.0, coeff: 1 }, { name: "Physique 1", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "Anglais 1", examWeight: 1.0, contWeight: 0.0, coeff: 1 } ] },
        "ST_S1": { displayName: "Science & Tech (ST) - S1", subjects: [ { name: "Maths 1", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Physique 1", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Chimie 1", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Informatique 1", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "M√©thodologie", examWeight: 1.0, contWeight: 0.0, coeff: 1 }, { name: "M√©tiers en ST", examWeight: 1.0, contWeight: 0.0, coeff: 1 }, { name: "Anglais 1", examWeight: 1.0, contWeight: 0.0, coeff: 1 } ] },
        "BIO_S1": { displayName: "Biologie (SNV) - S1", subjects: [ { name: "Biologie Cellulaire", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Chimie G√©n√©rale", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "Math√©matiques", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "G√©ologie", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "TCE (Expression)", examWeight: 1.0, contWeight: 0.0, coeff: 1 }, { name: "M√©thodologie", examWeight: 1.0, contWeight: 0.0, coeff: 1 } ] },
        "ARCHI_S1": { displayName: "Architecture - S1", subjects: [ { name: "Atelier de Conception", examWeight: 0.5, contWeight: 0.5, coeff: 4 }, { name: "HCA (Histoire)", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "TMC (Construction)", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "G√©om√©trie Descriptive", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "Math√©matiques", examWeight: 0.6, contWeight: 0.4, coeff: 1 }, { name: "Physique", examWeight: 0.6, contWeight: 0.4, coeff: 1 } ] },
        "MED_1": { displayName: "M√©decine (1√®re Ann√©e)", subjects: [ { name: "Anatomie", examWeight: 0.67, contWeight: 0.33, coeff: 3 }, { name: "Cytologie", examWeight: 0.67, contWeight: 0.33, coeff: 2 }, { name: "Physiologie", examWeight: 0.67, contWeight: 0.33, coeff: 2 }, { name: "Biochimie", examWeight: 0.67, contWeight: 0.33, coeff: 2 }, { name: "G√©n√©tique", examWeight: 0.67, contWeight: 0.33, coeff: 1 }, { name: "Biostatistique", examWeight: 0.67, contWeight: 0.33, coeff: 1 }, { name: "Chimie", examWeight: 0.67, contWeight: 0.33, coeff: 2 }, { name: "Physique (Biophysique)", examWeight: 0.67, contWeight: 0.33, coeff: 2 } ] },
        "MARKETING_S3": { displayName: "Marketing (S3)", subjects: [ { name: "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≥ŸàŸäŸÇŸäÿ©", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "ÿßŸÑÿßÿ™ÿµÿßŸÑÿßÿ™ ÿßŸÑÿ™ÿ≥ŸàŸäŸÇŸäÿ©", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "ÿ≥ŸÑŸàŸÉ ÿßŸÑŸÖÿ≥ÿ™ŸáŸÑŸÉ", examWeight: 0.6, contWeight: 0.4, coeff: 3 }, { name: "ŸÇÿßŸÜŸàŸÜ ÿßŸÑŸÖŸÜÿßŸÅÿ≥ÿ©", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "ŸÑÿ∫ÿ© ÿ£ÿ¨ŸÜÿ®Ÿäÿ© 01", examWeight: 0.0, contWeight: 1.0, coeff: 1 }, { name: "ÿ™ÿ≥ŸàŸäŸÇ ÿßŸÑÿÆÿØŸÖÿßÿ™", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "ÿßŸÑÿ™ÿ≥ŸàŸäŸÇ ÿßŸÑÿ±ŸÇŸÖŸä", examWeight: 0.6, contWeight: 0.4, coeff: 2 }, { name: "ÿ®ÿ≠Ÿàÿ´ ÿßŸÑÿ™ÿ≥ŸàŸäŸÇ 01", examWeight: 0.6, contWeight: 0.4, coeff: 2 } ] }
    };

    let appState = { currentSubjects: [], customPresets: {} };
    let isEditMode = false;
    let lastSelectedPreset = "";
    

    // Cache Key V6
    const STORAGE_KEY = 'appDataV6';

    window.onload = function() {
        try {
            if (window.AppInventor) {
                const savedJson = window.AppInventor.getWebViewString();
                if (savedJson && savedJson.length > 5) {
                    try {
                        const parsed = JSON.parse(savedJson);
                        if (Array.isArray(parsed)) appState.currentSubjects = parsed;
                        else if (parsed && parsed.currentSubjects) appState = parsed;
                    } catch(e) { loadDefault(); }
                } else { loadDefault(); }
            } else {
                const local = localStorage.getItem(STORAGE_KEY);
                if (local) appState = JSON.parse(local);
                else loadDefault();
            }
            if (!appState.currentSubjects || appState.currentSubjects.length === 0) loadDefault();
            renderApp();
            renderPresetDropdown();
        } catch (e) { loadDefault(); renderApp(); }
    };

    function loadDefault() { 
        appState.currentSubjects = JSON.parse(JSON.stringify(systemPresets["MARKETING_S3"].subjects)); 
    }

    function renderApp() {
        const container = document.getElementById('subjectsContainer');
        const editBtn = document.getElementById('editBtn');
        if (!container) return;
        
        if(isEditMode) {
            document.body.classList.add('editing');
            editBtn.innerHTML = `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>`;
            editBtn.setAttribute('aria-label', 'ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ');
        } else {
            document.body.classList.remove('editing');
            editBtn.innerHTML = `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
            editBtn.setAttribute('aria-label', 'ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ');
        }

        container.innerHTML = '';
        if (!appState.currentSubjects) appState.currentSubjects = [];

        appState.currentSubjects.forEach((sub, index) => {
            const cont = parseFloat(sub.cont) || 0;
            const exam = parseFloat(sub.exam) || 0;
            const coeff = parseFloat(sub.coeff) || 1;
            let avg = (sub.examWeight === 0) ? cont : (exam * sub.examWeight) + (cont * sub.contWeight);

            const card = document.createElement('article'); 
            card.className = 'card';
            card.id = 'card-' + index;
            const hasTD = sub.contWeight > 0;
            const hasExam = sub.examWeight > 0;

            card.innerHTML = `
                <div class="card-header">
                    <input type="text" class="subject-input ${isEditMode ? 'editable' : ''}" 
                           value="${sub.name}" ${isEditMode ? '' : 'disabled'} 
                           onchange="updateName(${index}, this.value)" aria-label="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©">
                    <div class="controls-wrapper">
                        <span class="coeff-badge" aria-label="ÿßŸÑŸÖÿπÿßŸÖŸÑ ${coeff}">ŸÖÿπÿßŸÖŸÑ ${coeff}</span>
                        <input type="number" class="coeff-edit" value="${coeff}" 
                               onchange="updateCoeff(${index}, this.value)" aria-label="ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑ">
                        <button class="btn-trash" onclick="deleteSubject(${index})" aria-label="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿßÿØÿ©">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="toggles-row">
                    <div class="toggle-chip ${hasTD ? 'active' : ''}" onclick="toggleType(${index}, 'TD')" role="button" aria-pressed="${hasTD}">TD</div>
                    <div class="toggle-chip ${hasExam ? 'active' : ''}" onclick="toggleType(${index}, 'Exam')" role="button" aria-pressed="${hasExam}">Exam</div>
                </div>
                <div class="grades-grid">
                    <div class="input-group ${hasTD ? '' : 'hidden'}">
                        <label class="floating-label" for="td-${index}">TD</label>
                        <input type="number" id="td-${index}" class="grade-input" value="${sub.cont || ''}" placeholder="-"
                               oninput="handleInput(${index}, 'cont', this)" ${isEditMode ? 'disabled' : ''}>
                    </div>
                    <div class="input-group ${hasExam ? '' : 'hidden'}">
                        <label class="floating-label" for="exam-${index}">Exam</label>
                        <input type="number" id="exam-${index}" class="grade-input" value="${sub.exam || ''}" placeholder="-"
                               oninput="handleInput(${index}, 'exam', this)" ${isEditMode ? 'disabled' : ''}>
                    </div>
                </div>
                <div class="card-footer">
                    <span>ÿßŸÑŸÖÿπÿØŸÑ</span>
                    <span class="score-display" id="score-${index}" style="color: ${getColor(avg)}">${avg.toFixed(2)}</span>
                </div>
            `;
            container.appendChild(card);
        });
        recalcTotals();
    }

    function Type(index, type) {
        const sub = appState.currentSubjects[index];
        if (type === 'Exam') {
            if (sub.examWeight > 0) { sub.examWeight = 0; sub.contWeight = 1; } 
            else { sub.examWeight = 0.6; sub.contWeight = 0.4; }
        } else if (type === 'TD') {
            if (sub.contWeight > 0) { sub.contWeight = 0; sub.examWeight = 1; } 
            else { sub.contWeight = 0.4; sub.examWeight = 0.6; }
        }
        renderApp(); saveData();
    }

    function handleInput(index, type, el) {
        let val = parseFloat(el.value);
        let error = false;

        if (val > 20) { el.value = 20; val = 20; error = true; }
        if (val < 0) { el.value = 0; val = 0; error = true; }

        if (error) {
            playErrorSound();
            el.classList.add('error-shake');
            setTimeout(() => el.classList.remove('error-shake'), 400);
        } else {
            playKey();
        }

        if (type === 'cont') appState.currentSubjects[index].cont = el.value;
        if (type === 'exam') appState.currentSubjects[index].exam = el.value;
        updateSubjectScore(index); recalcTotals(); saveData();
    }

    function updateSubjectScore(index) {
        const sub = appState.currentSubjects[index];
        const cont = parseFloat(sub.cont) || 0;
        const exam = parseFloat(sub.exam) || 0;
        let avg = (sub.examWeight === 0) ? cont : (exam * sub.examWeight) + (cont * sub.contWeight);
        const scoreEl = document.getElementById('score-' + index);
        if (scoreEl) { scoreEl.innerText = avg.toFixed(2); scoreEl.style.color = getColor(avg); }
    }

    function recalcTotals() {
        let totalW = 0, totalC = 0;
        appState.currentSubjects.forEach(s => {
            const c = parseFloat(s.cont) || 0;
            const e = parseFloat(s.exam) || 0;
            const cf = parseFloat(s.coeff) || 1;
            const a = (s.examWeight === 0) ? c : (e * s.examWeight) + (c * s.contWeight);
            totalW += (a * cf); totalC += cf;
        });
        const finalAvg = totalC > 0 ? (totalW / totalC) : 0;
        const finalEl = document.getElementById('finalAverage');
        if (finalEl) { finalEl.innerText = finalAvg.toFixed(2); finalEl.style.color = getColor(finalAvg); }
        
        if (finalAvg >= 10 && lastAvg < 10) { playClap(); }
        lastAvg = finalAvg;

        const ring = document.getElementById('ringCircle');
        if(ring) {
            const percent = Math.min(finalAvg / 20, 1);
            const offset = 502 - (percent * 502);
            ring.style.strokeDashoffset = offset; ring.style.stroke = getColor(finalAvg);
        }
    }

    function getColor(s) { return s >= 10 ? 'var(--neon-green)' : 'var(--neon-red)'; }

    function renderPresetDropdown() {
        const select = document.getElementById('presetSelect'); if (!select) return;
        select.innerHTML = '<option value="" disabled selected>ÿßÿÆÿ™ÿ± ŸÜŸÖŸàÿ∞ÿ¨ÿßŸã...</option>';
        const grp1 = document.createElement('optgroup'); grp1.label = "ÿ™ÿÆÿµÿµÿßÿ™ ÿ¨ÿßŸÖÿπŸäÿ© (DZ)";
        for (let k in systemPresets) { let o = document.createElement('option'); o.value = "SYS:" + k; o.innerText = systemPresets[k].displayName; grp1.appendChild(o); }
        select.appendChild(grp1);
        if (appState.customPresets && Object.keys(appState.customPresets).length > 0) {
            const grp2 = document.createElement('optgroup'); grp2.label = "ŸÜŸÖÿßÿ∞ÿ¨Ÿä ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©";
            for (let k in appState.customPresets) { let o = document.createElement('option'); o.value = "CUST:" + k; o.innerText = k; grp2.appendChild(o); }
            select.appendChild(grp2);
        }
    }

    function loadPreset(val) {
    if (!val) return;
    // ÿÆÿ≤ŸÜ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÇÿ®ŸÑ ŸÖÿß Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ±Ÿá
    lastSelectedPreset = val;
    if (confirm("ÿ™ÿ≠ŸÖŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿ≥ŸäŸÇŸàŸÖ ÿ®ŸÖÿ≥ÿ≠ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©. ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü")) {
        let newS = [];
        if (val.startsWith("SYS:")) newS = JSON.parse(JSON.stringify(systemPresets[val.substring(4)].subjects));
        else if (val.startsWith("CUST:")) newS = JSON.parse(JSON.stringify(appState.customPresets[val.substring(5)]));
        newS.forEach(s => { s.cont = ""; s.exam = ""; });
        appState.currentSubjects = newS; renderApp(); document.getElementById('presetSelect').value = ""; toggleEditMode(); saveData();
        // ÿÆŸÑŸä ÿ¢ÿÆÿ± ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿÆÿ≤ŸàŸÜ ÿ≠ÿ™Ÿâ ŸÑŸà ŸÅÿ±Ÿëÿ∫ŸÜÿß ŸÇŸäŸÖÿ© ÿßŸÑŸÄ select
        lastSelectedPreset = val;
    } 
}

    function saveCurrentAsPreset() {
        const name = prompt("ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖÿßŸã ŸÑŸáÿ∞ÿß ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨:");
        if (name && name.trim() !== "") {
            const clean = JSON.parse(JSON.stringify(appState.currentSubjects)); clean.forEach(s => { s.cont = ""; s.exam = ""; });
            if (!appState.customPresets) appState.customPresets = {}; appState.customPresets[name] = clean;
            alert("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨!"); renderPresetDropdown(); saveData();
        }
    }

    function deletePreset() {
    const sel = document.getElementById('presetSelect');
    // ÿßÿ≥ÿ™ÿπŸÖŸÑ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ£Ÿà ÿ¢ÿÆÿ± ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿÆÿ≤ŸàŸÜ
    const val = sel.value || lastSelectedPreset;
    if (!val) { alert("Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸÖŸàÿ∞ÿ¨ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ£ŸàŸÑÿßŸã."); return; }
    if (val.startsWith("SYS:")) { alert("ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ±ÿ≥ŸÖŸäÿ©."); return; }
    if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ÿü")) {
        delete appState.customPresets[val.substring(5)];
        renderPresetDropdown(); saveData();
        sel.value = "";
        lastSelectedPreset = "";
    }
}

    function toggleEditMode() { isEditMode = !isEditMode; renderApp(); playTap(); }
    function updateName(idx, val) { appState.currentSubjects[idx].name = val; saveData(); }
    function updateCoeff(idx, val) { appState.currentSubjects[idx].coeff = parseFloat(val) || 1; saveData(); renderApp(); }
    function deleteSubject(idx) { if(confirm('ÿ≠ÿ∞ŸÅÿü')) { appState.currentSubjects.splice(idx, 1); renderApp(); saveData(); } }
    function addNewSubject() { appState.currentSubjects.push({ name: "ŸÖÿßÿØÿ© ÿ¨ÿØŸäÿØÿ©", examWeight: 0.6, contWeight: 0.4, coeff: 1 }); renderApp(); saveData(); }
    function clearMarksOnly() { if(confirm('ŸÖÿ≥ÿ≠ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ÿü')) { appState.currentSubjects.forEach(s => { s.cont = ""; s.exam = ""; }); renderApp(); saveData(); } }
    
    function saveData() { 
        const j = JSON.stringify(appState); 
        if (window.AppInventor) window.AppInventor.setWebViewString(j); 
        localStorage.setItem(STORAGE_KEY, j); 
    }
</script>
</body>
</html>
